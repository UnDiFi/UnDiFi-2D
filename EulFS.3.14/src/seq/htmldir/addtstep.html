C
*=*=*=*= ADDTSTEP.html =*=*=*=*
<HEADER>
<TITLE>SUBROUTINE ADDTSTEP</TITLE>
</HEADER>
<BODY>
<H1>SUBROUTINE ADDTSTEP</H1>

<PRE>

      SUBROUTINE <A NAME=ADDTSTEP>ADDTSTEP</A>(<A HREF=#A>A</A>,<A HREF=#TSTEP>TSTEP</A>,<A HREF=#RHS>RHS</A>,<A HREF=#NR>NR</A>,<A HREF=#NOFVAR>NOFVAR</A>,<A HREF=#TIMEIMPL>TIMEIMPL</A>)
C
      IMPLICIT NONE
C
C     $Id: addtstep.F,v 1.7 1999/11/05 20:43:47 aldo Exp $
C
C
#include "include/finclude/petsc.h"
#include "include/finclude/vec.h"
#include "include/finclude/mat.h"
C
C     .. PETSc Matrices ..
      Mat A
C     .. PETSc Vectors ..
      Vec TSTEP,RHS,DIAG
C
      Scalar DIAG_V(1),TSTEP_V(1)
      PetscOffset DIAG_PTR,TSTEP_PTR
C
C     .. Scalar Arguments ..
      INTEGER <A NAME=NOFVAR>NOFVAR</A>,<A NAME=NR>NR</A>
      LOGICAL <A NAME=TIMEIMPL>TIMEIMPL</A>
C     ..
C     .. Local Scalars ..
      INTEGER <A NAME=IFAIL>IFAIL</A>,<A NAME=LOCA>LOCA</A>,<A NAME=LOCB>LOCB</A>,<A NAME=I>I</A>,<A NAME=J>J</A>
      DOUBLE PRECISION <A NAME=TMP>TMP</A>
C     ..
C     .. External Functions ..
C     ..
C
#ifdef MPI
      CALL <A NAME=ADDTSTEP_VECCREATEMPI_1  >VecCreateMPI</A>(<A HREF=#PETSC_COMM_WORLD>PETSC_COMM_WORLD</A>,<A HREF=#NR>NR</A>*<A HREF=#NOFVAR>NOFVAR</A>,<A HREF=#PETSC_DECIDE>PETSC_DECIDE</A>,
     +                  <A HREF=#DIAG>DIAG</A>,<A HREF=#IFAIL>IFAIL</A>)
#else
      CALL <A NAME=ADDTSTEP_VECCREATESEQ_1  >VecCreateSeq</A>(<A HREF=#PETSC_COMM_SELF>PETSC_COMM_SELF</A>,<A HREF=#NR>NR</A>*<A HREF=#NOFVAR>NOFVAR</A>,<A HREF=#DIAG>DIAG</A>,<A HREF=#IFAIL>IFAIL</A>)
#endif
      CALL <A NAME=ADDTSTEP_VECGETARRAY_1  >VecGetArray</A>(<A HREF=#TSTEP>TSTEP</A>,<A HREF=#TSTEP_V>TSTEP_V</A>,<A HREF=#TSTEP_PTR>TSTEP_PTR</A>,<A HREF=#IFAIL>IFAIL</A>)
      CALL <A NAME=ADDTSTEP_VECGETARRAY_2  >VecGetArray</A>(<A HREF=#DIAG>DIAG</A>,<A HREF=#DIAG_V>DIAG_V</A>,<A HREF=#DIAG_PTR>DIAG_PTR</A>,<A HREF=#IFAIL>IFAIL</A>)
      DO 100 <A HREF=#I>I</A> = 1, <A HREF=#NR>NR</A>
          <A HREF=#LOCB>LOCB</A> = <A HREF=#TSTEP_PTR>TSTEP_PTR</A> + <A HREF=#I>I</A>
          <A HREF=#TMP>TMP</A> = <A NAME=ADDTSTEP_TSTEP_V_1  >TSTEP_V</A>(<A HREF=#LOCB>LOCB</A>)
          DO 100 <A HREF=#J>J</A> = 1,<A HREF=#NOFVAR>NOFVAR</A>
             <A HREF=#LOCA>LOCA</A> = <A HREF=#DIAG_PTR>DIAG_PTR</A> + (<A HREF=#I>I</A>-1)*<A HREF=#NOFVAR>NOFVAR</A> + <A HREF=#J>J</A>
             <A HREF=#DIAG_V>DIAG_V</A>(<A HREF=#LOCA>LOCA</A>) = <A HREF=#TMP>TMP</A>
  100 CONTINUE
      CALL <A NAME=ADDTSTEP_VECRESTOREARRAY_1  >VecRestoreArray</A>(<A HREF=#TSTEP>TSTEP</A>,<A NAME=ADDTSTEP_TSTEP_V_2  >TSTEP_V</A>,<A HREF=#TSTEP_PTR>TSTEP_PTR</A>,<A HREF=#IFAIL>IFAIL</A>)
      CALL <A NAME=ADDTSTEP_VECRESTOREARRAY_2  >VecRestoreArray</A>(<A HREF=#DIAG>DIAG</A>,<A HREF=#DIAG_V>DIAG_V</A>,<A HREF=#DIAG_PTR>DIAG_PTR</A>,<A HREF=#IFAIL>IFAIL</A>)

      IF( <A HREF=#TIMEIMPL>TIMEIMPL</A> )THEN
          CALL <A NAME=ADDTSTEP_MATDIAGONALSHIFT_1  >MatDiagonalShift</A>(<A HREF=#A>A</A>,<A HREF=#DIAG>DIAG</A>,<A HREF=#IFAIL>IFAIL</A>)
      ELSE
          CALL <A NAME=ADDTSTEP_VECPOINTWISEDIVIDE_1  >VecPointwiseDivide</A>(<A HREF=#RHS>RHS</A>,<A HREF=#DIAG>DIAG</A>,<A HREF=#RHS>RHS</A>,<A HREF=#IFAIL>IFAIL</A>)
      ENDIF
      CALL <A NAME=ADDTSTEP_VECDESTROY_1  >VecDestroy</A>(<A HREF=#DIAG>DIAG</A>,<A HREF=#IFAIL>IFAIL</A>)
      RETURN

      END
</PRE>
</BODY>
